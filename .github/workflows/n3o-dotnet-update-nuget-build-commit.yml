name: 'dotnet-upgrade-nuget-build-commit'

on:
  workflow_call:
    inputs:
      working-directory:
        type: string
        default: src
      
      services-list:
        description: List of services to upgrade Nuget packages
        required: true
        type: string
        
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: setup-dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.x'
          
      - name: n3o private tool install
        uses: n3oltd/actions/.github/actions/n3o-dotnet-tool-install@main
        with:
          gh-packages-token: ${{ secrets.GH_PACKAGES_TOKEN }}
          gh-packages-user: ${{ secrets.GH_PACKAGES_NUGET_USERNAME }}
      
      - name: update nuget packages
        env:
          GH_TOKEN: ${{ secrets.GH_REPO_PACKAGES_TOKEN }} 
        run: |
          dotnet nuget update source n3oltd -u n3oltd -p ${{ secrets.GH_PACKAGES_TOKEN }} --store-password-in-clear-tex
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

          services=$(echo '${{ inputs.services-list }}' | jq -c -r '.[]')

          for service in $services; do
            echo "Processing service: $service"

            mkdir -p "$service"
            git clone "https://github.com/n3oltd/$service.git" "$service"

            (
              cd "$service"
              git config user.name "github-actions"
              git config user.email "github-actions@github.com"
              
              dotnet tool run n3o nuget upgrade-our-packages -v -p "src"

              if [ -n "$(git status --porcelain)" ]; then
                git add .
                git commit -m "Upgraded NuGet packages"
                git push origin main
              else
                echo "No changes to commit in $service"
              fi
            )
          done
      