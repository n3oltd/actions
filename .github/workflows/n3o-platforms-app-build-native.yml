name: Build Platforms App Native

on:
  workflow_call:
    inputs:
      subscription-code:
        type: string
        required: true
      platform:
        type: string
        required: true

env:
  GH_PAT: ${{ secrets.GH_PACKAGES_TOKEN }}

jobs:
  build-native:
    name: Build Native App
    runs-on: ${{ inputs.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and Configure
        run: |
          BASE_URL="https://cdn.n3o.cloud/connect-${{ inputs.subscription-code }}/build"

          curl -fSsL -o apps/platforms-app/build/app.json "$BASE_URL/app.json" &
          curl -fSsL -o apps/platforms-app/build/themes.json "$BASE_URL/themes.json" &
          wait

          APP_NAME=$(jq -r '.appName' apps/platforms-app/build/app.json)
          APP_IDENTIFIER=$(jq -r '.packageName' apps/platforms-app/build/app.json)
          # ASSOCIATED_DOMAIN

          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_IDENTIFIER=$APP_IDENTIFIER" >> $GITHUB_ENV
          echo "VERSION_NAME=$(date +"%Y.%m.%d")-${{ github.run_number }}" >> $GITHUB_ENV
          echo "CI_BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

          THEME_FILE="apps/platforms-app/build/themes.json"

          ICON_BG=$(jq -r '.default.parameters.colors.iconBackground' $THEME_FILE)
          ICON_BG_DARK=$(jq -r '.default.parameters.colors.iconBackgroundDark' $THEME_FILE)
          SPLASH_BG=$(jq -r '.default.parameters.colors.splashBackground' $THEME_FILE)
          SPLASH_BG_DARK=$(jq -r '.default.parameters.colors.splashBackgroundDark' $THEME_FILE)

          echo "ICON_BG=$ICON_BG" >> $GITHUB_ENV
          echo "ICON_BG_DARK=$ICON_BG_DARK" >> $GITHUB_ENV
          echo "SPLASH_BG=$SPLASH_BG" >> $GITHUB_ENV
          echo "SPLASH_BG_DARK=$SPLASH_BG_DARK" >> $GITHUB_ENV

          # WARNING: The 'mobileApp' list containing asset URLs is missing from the new themes.json.
          # The code below is a placeholder for how you would structure it if the data existed.

          # urls=$(jq -r '.default.mobileApp | to_entries[] | "\(.value.url) \(.value.filename)"' $THEME_FILE)
          # if [ ! -z "$urls" ]; then
          #   echo "$urls" | while read -r url fname; do
          #     curl -fSsL -o "apps/platforms-app/assets/$fname" "$url"
          #   done
          # fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: NPM Install and Build
        run: |
          npm install --legacy-peer-deps # TODO: see how to replace this with `clean-install`
          npm run build:platforms-app

      - name: Sync capacitor plugins
        run: |
          npx trapeze run config.yml -y
          npx @capacitor/assets generate \
            --iconBackgroundColor "${ICON_BG}" \
            --iconBackgroundColorDark "${ICON_BG_DARK}" \
            --splashBackgroundColor "${SPLASH_BG}" \
            --splashBackgroundColorDark "${SPLASH_BG_DARK}"
          npx cap sync
        working-directory: apps/platforms-app

      - name: Build and Publish for Android # TODO: run this on ubuntu?
        if: ${{ inputs.platform == 'android' }}
        uses: n3oltd/actions/.github/actions/n3o-build-apk@main
        with:
          working-directory: apps/platforms-app
          android-keystore-base64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          android-key-alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          android-keystore-password: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          google-play-key-base64: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}
          app-identifier: ${{ env.APP_IDENTIFIER}}

      - name: Build and Publish for iOS
        if: ${{ inputs.platform == 'ios' }}
        uses: n3oltd/actions/.github/actions/n3o-build-ipa@main
        with:
          working-directory: apps/platforms-app
          ios-certificate-base64: ${{ secrets.IOS_P12_BASE64 }}
          ios-certificate-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          asc-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          asc-issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          asc-key-content: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          app-identifier: ${{ env.APP_IDENTIFIER }}
