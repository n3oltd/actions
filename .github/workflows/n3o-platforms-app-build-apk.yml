name: 'Build & Push Platforms App APK'

on:
  workflow_call:
    inputs:
      subscription-code:
        type: string
        required: true
        
env:
  GH_PAT: ${{ secrets.GH_PACKAGES_TOKEN }}
  
jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch configuration.json
        run: |
          wget -O configuration.json "https://cdn-beta.n3o.cloud/connect-${{ inputs.subscription-code }}/build/configuration.json"

      - name: Download mobileApp assets
        run: |
          urls=$(jq -r '.theme.mobileApp | to_entries[] | .value' configuration.json)
          for url in $urls; do
            fname=$(basename "${url%%\?*}")   # strip query params
            wget -O "apps/platforms-app/assets/$fname" "$url"
          done
          
      - name: Export env variables from config
        id: setenv
        run: |
          APP_NAME=$(jq -r '.app.appName' configuration.json)
          PACKAGE_NAME=$(jq -r '.app.packageName' configuration.json)
          VERSION_NAME=$(date +"%Y.%m.%d")-${{ github.run_number }}
          CI_BUILD_NUMBER=${{ github.run_number }}
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "CI_BUILD_NUMBER=$CI_BUILD_NUMBER" >> $GITHUB_ENV
      
      - name: npm install and build
        run: |
          npm clean-install
          npm run build    
          
      - name: sync capacitor plugins
        run: |
          npx trapeze run config.yml -y
          npx cap sync
          npx capacitor-assets generate
        working-directory: apps/platforms-app
        
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"
          cache: "gradle"          

      - name: Decode Keystore File
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/my-release-key.keystore
        working-directory: apps/platforms-app
        
      - name: Create Signing Config
        run: |
          echo "
          android {
              signingConfigs {
                  release {
                      storeFile file('my-release-key.keystore')
                      storePassword '${{ secrets.ANDROID_KEYSTORE_PASSWORD }}'
                      keyAlias '${{ secrets.ANDROID_KEY_ALIAS }}'
                      keyPassword '${{ secrets.ANDROID_KEYSTORE_PASSWORD }}'
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          " >> android/app/build.gradle
        working-directory: apps/platforms-app

      - name: Build APK        
        run: ./gradlew assembleRelease --no-daemon
        working-directory: apps/platforms-app/android

      #this can be replaced with fastlane
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: capacitor-apk
          path: apps/platforms-app/android/app/build/outputs/apk/release/app-*.apk